<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProDev Resume Builder (Ultimate)</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Default Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Merriweather:wght@300;400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #2980b9;
            --bg-color: #f0f2f5;
            --sidebar-width: 500px;
            --sidebar-bg: #f4f4f4;
            --resume-font: 'Inter', sans-serif; /* Default Font */
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Interface Font */
            margin: 0;
            background-color: var(--bg-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- EDITOR (LEFT) --- */
        .editor-panel {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .editor-header {
            padding: 15px 20px;
            background: #222;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .header-controls { display: flex; gap: 8px; align-items: center; }

        /* Design Tools */
        .design-toolbar {
            display: flex; gap: 10px; padding-top: 10px; border-top: 1px solid #444; align-items: center;
        }

        .tool-btn, .font-select {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
        }
        .tool-btn:hover, .font-select:hover { background: rgba(255,255,255,0.2); }
        .font-select option { color: #333; }

        input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; padding: 0; }

        .editor-content { padding: 20px; overflow-y: auto; flex: 1; }

        .section-group { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .section-group h3 { font-size: 0.9rem; text-transform: uppercase; color: #555; margin-bottom: 15px; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }

        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { margin-bottom: 12px; flex: 1; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #555; }

        input, textarea, select {
            width: 100%; padding: 8px 12px; border: 1px solid #ccc;
            border-radius: 4px; font-size: 0.9rem; transition: 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--accent-color); outline: none; }
        textarea { resize: vertical; height: 70px; }

        /* Social Row Layout */
        .social-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .social-select { width: 30% !important; flex-shrink: 0; }
        .social-base {
            width: 30% !important; background: #f8f9fa; color: #666; font-size: 0.8rem;
            border-right: none; border-top-right-radius: 0; border-bottom-right-radius: 0;
        }
        .social-user { flex: 1; border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .social-base.hidden { display: none; }
        .social-user.full-width { width: 70% !important; border-radius: 4px; }
        .file-upload-btn { display: none; margin-top: 5px; font-size: 0.8rem; }

        /* Dynamic Lists */
        .dynamic-list { display: flex; flex-direction: column; gap: 10px; }
        .dynamic-item { background: #f8f9fa; padding: 15px; border: 1px solid #e9ecef; border-radius: 6px; position: relative; }
        .item-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .btn-mini { background: #eee; color: #555; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-mini:hover { background: #ddd; }
        .btn-del { background: #ff7675; color: white; }

        .btn-add { background: #e8f4fd; color: var(--accent-color); width: 100%; padding: 8px; margin-top: 5px; border: 1px dashed var(--accent-color); cursor: pointer; }
        .btn-add-section { background: var(--primary-color); color: white; width: 100%; padding: 10px; margin-top: 20px; border: none; border-radius: 4px; cursor: pointer; }

        .action-bar { padding: 15px; border-top: 1px solid #eee; background: white; display: flex; gap: 10px; }
        .btn-download { flex: 1; background: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 12px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
        .btn-reset { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 0 15px; cursor: pointer; }

        /* New Buttons for JSON */
        .btn-action { background: #95a5a6; color: white; border: none; border-radius: 4px; padding: 0 15px; cursor: pointer; transition: background 0.2s; }
        .btn-action:hover { background: #7f8c8d; }

        /* --- PREVIEW (RIGHT) --- */
        .preview-panel {
            flex: 1; padding: 40px; overflow-y: auto; background: #525659;
            display: flex; justify-content: center;
        }

        #resume {
            width: 210mm; min-height: 297mm; padding: 0;
            box-shadow: 0 0 20px rgba(0,0,0,0.3); display: flex; color: #333;
            /* Faux Column Fix */
            background-image: linear-gradient(to right, var(--sidebar-bg) 32%, white 32%);
            background-color: white;
            /* Font Application */
            font-family: var(--resume-font);
        }

        .resume-sidebar { width: 32%; padding: 30px 20px; display: flex; flex-direction: column; }
        .resume-main { width: 68%; padding: 30px 30px; }

        .profile-img-container {
            width: 150px; height: 150px; margin: 0 auto 20px auto;
            border-radius: 50%; overflow: hidden; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none; background-size: cover; background-position: center;
        }

        h1 { margin: 0; font-size: 2.2rem; line-height: 1.1; color: var(--primary-color); text-transform: uppercase; }
        .role { color: var(--accent-color); font-size: 1.1rem; margin-top: 5px; font-weight: 500; margin-bottom: 25px; }

        .section-title {
            font-size: 0.95rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--primary-color);
            border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px;
        }

        a { color: inherit; text-decoration: none; }
        .contact-link:hover { color: var(--accent-color); text-decoration: underline; }
        .resume-link { color: var(--accent-color); }

        .contact-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.85rem; word-break: break-all; }
        .icon-box { width: 20px; display: flex; justify-content: center; align-items: center; color: var(--accent-color); }
        .icon-box img { width: 16px; height: 16px; object-fit: contain; }

        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { background: white; border: 1px solid #ccc; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }

        .res-item { margin-bottom: 18px; }
        .res-title { font-weight: 700; font-size: 1rem; color: #222; }
        .res-subtitle { font-weight: 500; font-size: 0.9rem; color: #555; margin-bottom: 4px; }
        .res-date { font-size: 0.8rem; color: #777; white-space: nowrap; font-style: italic; }
        .res-desc { font-size: 0.9rem; color: #444; line-height: 1.5; white-space: pre-line; margin-top: 5px; }
        .res-desc ul { margin: 5px 0; padding-left: 20px; }

        .res-header { display: flex; justify-content: space-between; align-items: baseline; }
        .project-link { font-size: 0.8rem; margin-left: 10px; color: var(--accent-color); }
        .tech-stack { font-size: 0.8rem; color: #666; margin-bottom: 5px; font-style: italic; }

        .hidden { display: none !important; }

        /* Font Loader Hidden Elements */
        #hidden-font-input { display: none; }

        @media print {
            body { height: auto; background: white; overflow: visible; }
            .editor-panel, .preview-panel { display: none; }
            .preview-panel { display: block; padding: 0; width: 100%; }
            #resume { width: 100%; box-shadow: none; min-height: 100vh; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            @page { size: A4; margin: 0; }
        }

        .btn-source {
            display: inline-flex;
            align-items: center;
            gap: 8px;

            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 500;

            color: white;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 6px;

            text-decoration: none;
            cursor: pointer;

            transition: background 0.2s ease, transform 0.1s ease;
        }

        .btn-source:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .btn-source i {
            font-size: 1rem;
        }


    </style>
</head>
<body>

<!-- LEFT: EDITOR -->
<div class="editor-panel">
    <div class="editor-header">
        <div class="header-top">
            <h2>Resume Builder</h2>
            <div class="header-controls">
                <select id="lang-selector" class="tool-btn" onchange="changeLanguage()">
                    <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
                    <option value="de">ðŸ‡©ðŸ‡ª DE</option>
                </select>
            </div>
            <a href="https://github.com/ed23x/builder"
               target="_blank"
               rel="noreferrer"
               class="btn-source">
                <i class="fab fa-github"></i>
                Source Code
            </a>
        </div>

        <!-- DESIGN TOOLBAR -->
        <div class="design-toolbar">
            <input type="color" id="color-picker" value="#2c3e50" title="Primary Color" onchange="updateColors()">

            <select id="font-selector" class="font-select" onchange="handleFontSelection()">
                <option value="Inter">Inter (Default)</option>
                <option value="Merriweather">Merriweather (Serif)</option>
                <option value="Roboto Mono">Roboto Mono (Code)</option>
                <option value="Open Sans">Open Sans</option>
                <option value="Lato">Lato</option>
                <option value="Montserrat">Montserrat</option>
                <option value="Playfair Display">Playfair Display</option>
                <option value="os-font">Load Google Font...</option>
                <option value="upload-font">Upload .ttf/.woff...</option>
            </select>

            <!-- Hidden inputs for custom fonts -->
            <input type="text" id="google-font-input" class="tool-btn" style="display:none; width:120px;" placeholder="Font Name (e.g. Oswald)" onchange="loadGoogleFont(this.value)">
            <input type="file" id="upload-font-input" style="display:none;" accept=".ttf,.woff,.woff2,.otf" onchange="loadLocalFont(this)">
        </div>
    </div>

    <div class="editor-content">
        <!-- Profile Info -->
        <div class="section-group">
            <h3 data-lbl="info">Profile</h3>
            <div class="form-group"><label>Profile Picture</label><input type="file" id="inp-img" accept="image/*" onchange="loadPhoto(event)"></div>
            <div class="form-row">
                <div class="form-group"><label>Full Name</label><input type="text" id="inp-name" placeholder="John Doe" oninput="saveAndRender()"></div>
                <div class="form-group"><label>Job Title</label><input type="text" id="inp-role" placeholder="Developer" oninput="saveAndRender()"></div>
            </div>
        </div>

        <!-- CONTACT & SOCIALS -->
        <div class="section-group">
            <h3 data-lbl="contact">Contact & Socials</h3>
            <div id="list-contact" class="dynamic-list"></div>
            <button class="btn-add" onclick="addContact()">+ Add Link / Field</button>
        </div>

        <div class="section-group">
            <h3 data-lbl="summary">Summary</h3>
            <textarea id="inp-summary" placeholder="Summary..." oninput="saveAndRender()"></textarea>
        </div>

        <div class="section-group">
            <h3 data-lbl="skills">Skills & Languages</h3>
            <div class="form-group"><label>Tech Skills</label><textarea id="inp-skills" placeholder="JS, React..." oninput="saveAndRender()" style="height:50px"></textarea></div>
            <div class="form-group"><label>Languages</label><input type="text" id="inp-langs" placeholder="English, German" oninput="saveAndRender()"></div>
        </div>

        <!-- Standard Sections -->
        <div class="section-group">
            <h3 data-lbl="projects">Projects</h3>
            <div id="list-projects" class="dynamic-list"></div>
            <button class="btn-add" onclick="addItem('projects')">+ Add Project</button>
        </div>

        <div class="section-group">
            <h3 data-lbl="experience">Experience</h3>
            <div id="list-exp" class="dynamic-list"></div>
            <button class="btn-add" onclick="addItem('experience')">+ Add Position</button>
        </div>

        <div class="section-group">
            <h3 data-lbl="education">Education</h3>
            <div id="list-edu" class="dynamic-list"></div>
            <button class="btn-add" onclick="addItem('education')">+ Add Education</button>
        </div>

        <!-- Custom Sections -->
        <div id="custom-sections-area"></div>
        <button class="btn-add-section" onclick="addCustomSection()">+ Add New Section</button>

    </div>

    <div class="action-bar">
        <button class="btn-reset" onclick="clearData()" title="Reset"><i class="fas fa-trash"></i></button>

        <!-- NEW JSON EXPORT/IMPORT BUTTONS -->
        <button class="btn-action" onclick="exportJSON()" title="Export JSON"><i class="fas fa-file-export"></i></button>
        <button class="btn-action" onclick="triggerImport()" title="Import JSON"><i class="fas fa-file-import"></i></button>

        <button class="btn-download" onclick="downloadPDF()">
            <i class="fas fa-file-pdf"></i> <span id="btn-dl-text">Download PDF</span>
        </button>
    </div>

    <!-- Hidden File Input for Import -->
    <input type="file" id="import-json-file" accept=".json" style="display:none;" onchange="loadJSONFile(this)">
</div>

<!-- RIGHT: PREVIEW -->
<div class="preview-panel">
    <div id="resume">
        <div class="resume-sidebar">
            <div id="out-img-container" class="profile-img-container"></div>

            <div id="sec-contact">
                <div class="section-title" data-i18n="contact">Contact</div>
                <div id="out-contact-list"></div>
            </div>

            <div id="sec-skills">
                <div class="section-title" data-i18n="skills">Skills</div>
                <div id="out-skills" class="tag-container"></div>
            </div>

            <div id="sec-langs">
                <div class="section-title" data-i18n="languages">Languages</div>
                <div id="out-langs" class="tag-container"></div>
            </div>
        </div>

        <div class="resume-main">
            <h1 id="out-name">Your Name</h1>
            <div class="role" id="out-role">Your Role</div>

            <div id="sec-summary">
                <div class="section-title" data-i18n="profile">Profile</div>
                <div id="out-summary" class="res-desc"></div>
            </div>

            <div id="sec-projects">
                <div class="section-title" data-i18n="projects">Projects</div>
                <div id="out-projects"></div>
            </div>

            <div id="sec-exp">
                <div class="section-title" data-i18n="experience">Experience</div>
                <div id="out-exp"></div>
            </div>

            <div id="sec-edu">
                <div class="section-title" data-i18n="education">Education</div>
                <div id="out-edu"></div>
            </div>

            <div id="out-custom-sections"></div>
        </div>
    </div>
</div>

<script>
    /* --- CONFIGURATION --- */
    const socialConfig = {
        'email': { label: 'Email', icon: 'fas fa-envelope', base: '', type: 'direct' },
        'phone': { label: 'Phone', icon: 'fas fa-phone', base: '', type: 'direct' },
        'location': { label: 'Location', icon: 'fas fa-map-marker-alt', base: '', type: 'direct' },
        'website': { label: 'Website', icon: 'fas fa-globe', base: 'https://', type: 'direct' },
        'github': { label: 'GitHub', icon: 'fab fa-github', base: 'github.com/', type: 'social' },
        'linkedin': { label: 'LinkedIn', icon: 'fab fa-linkedin', base: 'linkedin.com/in/', type: 'social' },
        'twitter': { label: 'X (Twitter)', icon: 'fab fa-x-twitter', base: 'x.com/', type: 'social' },
        'instagram': { label: 'Instagram', icon: 'fab fa-instagram', base: 'instagram.com/', type: 'social' },
        'discord': { label: 'Discord', icon: 'fab fa-discord', base: '', type: 'social' },
        'signal': { label: 'Signal', icon: 'fab fa-signal-messenger', base: 'signal.me/#p/', type: 'social' },
        'youtube': { label: 'YouTube', icon: 'fab fa-youtube', base: 'youtube.com/@', type: 'social' },
        'custom': { label: 'â¬†ï¸ Custom', icon: '', base: '', type: 'social' }
    };

    const translations = {
        en: { contact: "Contact", education: "Education", skills: "Tech Skills", languages: "Languages", profile: "Profile", projects: "Projects", experience: "Experience", download: "Download PDF" },
        de: { contact: "Kontakt", education: "Ausbildung", skills: "Skills", languages: "Sprachen", profile: "Profil", projects: "Projekte", experience: "Erfahrung", download: "PDF Herunterladen" }
    };
    let currentLang = 'en';

    /* --- INITIALIZATION --- */
    window.onload = function() {
        loadFromStorage();
        if(document.querySelectorAll('#list-contact .dynamic-item').length === 0) {
            addContact('email'); addContact('phone'); addContact('location');
        }
        if(document.querySelectorAll('#list-exp .dynamic-item').length === 0) addItem('experience');
        if(document.querySelectorAll('#list-edu .dynamic-item').length === 0) addItem('education');
        saveAndRender();
    };

    /* --- FONTS LOGIC --- */
    function handleFontSelection() {
        const select = document.getElementById('font-selector');
        const googleInput = document.getElementById('google-font-input');
        const uploadInput = document.getElementById('upload-font-input');
        const val = select.value;

        // Hide/Show Inputs
        googleInput.style.display = 'none';
        uploadInput.style.display = 'none';

        if(val === 'os-font') {
            googleInput.style.display = 'block';
            googleInput.focus();
        } else if (val === 'upload-font') {
            uploadInput.click();
        } else {
            // Apply Standard or already loaded Google Fonts
            loadGoogleFont(val);
        }
    }

    function loadGoogleFont(fontName) {
        if(!fontName) return;
        // Create Link Tag dynamically
        const link = document.createElement('link');
        link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g, '+')}&display=swap`;
        link.rel = 'stylesheet';
        document.head.appendChild(link);

        // Apply Font
        document.documentElement.style.setProperty('--resume-font', `'${fontName}', sans-serif`);
        saveAndRender();
    }

    function loadLocalFont(input) {
        const file = input.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const fontFace = new FontFace('CustomUploadedFont', e.target.result);
                fontFace.load().then(loadedFace => {
                    document.fonts.add(loadedFace);
                    document.documentElement.style.setProperty('--resume-font', 'CustomUploadedFont');
                    saveAndRender();
                });
            }
            reader.readAsArrayBuffer(file);
        }
    }

    /* --- CONTACT LOGIC --- */
    function generateId() { return Date.now() + Math.random().toString(36).substr(2, 9); }

    function addContact(preKey = 'email', preBase = '', preVal = '', customImg = null) {
        const id = generateId();
        let opts = '';
        for (const [key, val] of Object.entries(socialConfig)) {
            opts += `<option value="${key}" ${key === preKey ? 'selected' : ''}>${val.label}</option>`;
        }
        const conf = socialConfig[preKey];
        const isSocial = conf.type === 'social';
        const baseVal = preBase !== '' ? preBase : conf.base;

        const html = `
                <div class="dynamic-item" id="${id}" data-custom-icon="${customImg || ''}">
                    <div class="item-controls"><button class="btn-mini btn-del" onclick="removeItem('${id}')">x</button></div>
                    <div class="social-row">
                        <select class="social-select" onchange="handleSocialChange(this, '${id}')">${opts}</select>
                        <input type="text" class="social-base ${isSocial ? '' : 'hidden'}" placeholder="Base URL" value="${baseVal}" oninput="saveAndRender()">
                        <input type="text" class="social-user ${isSocial ? '' : 'full-width'}" placeholder="Value" value="${preVal}" oninput="saveAndRender()">
                    </div>
                    <input type="file" class="file-upload-btn" accept="image/*" onchange="handleCustomIcon(this, '${id}')">
                </div>`;
        document.getElementById('list-contact').insertAdjacentHTML('beforeend', html);
        if(preKey === 'custom') document.querySelector(`#${id} .file-upload-btn`).style.display = 'block';
        saveAndRender();
    }

    function handleSocialChange(select, id) {
        const key = select.value;
        const item = document.getElementById(id);
        const conf = socialConfig[key];
        const baseInput = item.querySelector('.social-base');
        const userInput = item.querySelector('.social-user');
        const fileInput = item.querySelector('.file-upload-btn');

        if(key !== 'custom') baseInput.value = conf.base;

        if(conf.type === 'social') {
            baseInput.classList.remove('hidden');
            userInput.classList.remove('full-width');
            userInput.placeholder = "Username";
        } else {
            baseInput.classList.add('hidden');
            userInput.classList.add('full-width');
            userInput.placeholder = "Value";
        }

        if(key === 'custom') {
            fileInput.style.display = 'block';
        } else {
            fileInput.style.display = 'none';
            item.setAttribute('data-custom-icon', '');
        }
        saveAndRender();
    }

    function handleCustomIcon(input, id) {
        const file = input.files[0];
        if(file) {
            const r = new FileReader();
            r.onload = function(e) { document.getElementById(id).setAttribute('data-custom-icon', e.target.result); saveAndRender(); };
            r.readAsDataURL(file);
        }
    }

    /* --- STANDARD ITEMS & CUSTOM SECTIONS --- */
    function addItem(type, values = null) {
        const id = generateId();
        let content = '', targetId = '';
        if(type === 'projects') {
            targetId = 'list-projects';
            content = `<div class="form-group"><input type="text" class="i-title" placeholder="Project Name" value="${values?.['i-title']||''}" oninput="saveAndRender()"></div><div class="form-group"><input type="text" class="i-link" placeholder="URL" value="${values?.['i-link']||''}" oninput="saveAndRender()"></div><div class="form-group"><input type="text" class="i-stack" placeholder="Tech Stack" value="${values?.['i-stack']||''}" oninput="saveAndRender()"></div><div class="form-group"><textarea class="i-desc" placeholder="Description..." oninput="saveAndRender()">${values?.['i-desc']||''}</textarea></div>`;
        } else if(type === 'experience') {
            targetId = 'list-exp';
            content = `<div class="form-group"><input type="text" class="i-title" placeholder="Job Title" value="${values?.['i-title']||''}" oninput="saveAndRender()"></div><div class="form-group"><input type="text" class="i-company" placeholder="Company" value="${values?.['i-company']||''}" oninput="saveAndRender()"></div><div class="form-group"><input type="text" class="i-date" placeholder="Date" value="${values?.['i-date']||''}" oninput="saveAndRender()"></div><div class="form-group"><textarea class="i-desc" placeholder="Responsibilities..." oninput="saveAndRender()">${values?.['i-desc']||''}</textarea></div>`;
        } else if(type === 'education') {
            targetId = 'list-edu';
            content = `<div class="form-group"><input type="text" class="i-degree" placeholder="Degree" value="${values?.['i-degree']||''}" oninput="saveAndRender()"></div><div class="form-group"><input type="text" class="i-school" placeholder="School" value="${values?.['i-school']||''}" oninput="saveAndRender()"></div><div class="form-group"><input type="text" class="i-date" placeholder="Date" value="${values?.['i-date']||''}" oninput="saveAndRender()"></div>`;
        }
        document.getElementById(targetId).insertAdjacentHTML('beforeend', `<div class="dynamic-item" id="${id}"><div class="item-controls"><button class="btn-mini btn-del" onclick="removeItem('${id}')">x</button></div>${content}</div>`);
        if(!values) saveAndRender();
    }

    function addCustomSection(existingId = null, titleVal = '', items = []) {
        const id = existingId || 'sec-' + generateId();
        const container = document.getElementById('custom-sections-area');
        const html = `<div class="section-group custom-section-block" id="${id}"><h3><input type="text" class="sec-title-inp" placeholder="Section Title" value="${titleVal}" oninput="saveAndRender()" style="width:70%; border:none; border-bottom:1px solid #ccc; background:transparent; font-weight:bold; color:var(--primary-color)"><button class="btn-mini btn-del" onclick="removeSection('${id}')">Remove</button></h3><div class="dynamic-list" id="list-${id}"></div><button class="btn-add" onclick="addCustomItem('list-${id}')">+ Add Item</button></div>`;
        container.insertAdjacentHTML('beforeend', html);
        if(items.length > 0) items.forEach(itm => addCustomItem(`list-${id}`, itm));
        else if (!existingId) addCustomItem(`list-${id}`);
    }

    function addCustomItem(listId, vals = null) {
        const id = generateId();
        const html = `<div class="dynamic-item" id="${id}"><div class="item-controls"><button class="btn-mini btn-del" onclick="removeItem('${id}')">x</button></div><div class="form-group"><input type="text" class="i-title" placeholder="Title" value="${vals?.title || ''}" oninput="saveAndRender()"></div><div class="form-group"><textarea class="i-desc" placeholder="Details" oninput="saveAndRender()">${vals?.desc || ''}</textarea></div></div>`;
        document.getElementById(listId).insertAdjacentHTML('beforeend', html);
        saveAndRender();
    }

    function removeItem(id) { document.getElementById(id).remove(); saveAndRender(); }
    function removeSection(id) { if(confirm("Remove section?")) { document.getElementById(id).remove(); saveAndRender(); } }
    function clearData() { if(confirm("Reset all data?")) { localStorage.removeItem('resumeDataUltimate'); location.reload(); } }

    /* --- RENDER LOGIC --- */
    function updateResume() {
        document.getElementById('out-name').innerText = document.getElementById('inp-name').value;
        document.getElementById('out-role').innerText = document.getElementById('inp-role').value;
        toggleSection('sec-summary', document.getElementById('inp-summary').value, 'out-summary', formatText(document.getElementById('inp-summary').value));

        const contactContainer = document.getElementById('out-contact-list');
        contactContainer.innerHTML = '';
        document.querySelectorAll('#list-contact .dynamic-item').forEach(item => {
            const key = item.querySelector('select').value;
            const base = item.querySelector('.social-base').value.trim();
            const user = item.querySelector('.social-user').value.trim();
            const customImg = item.getAttribute('data-custom-icon');
            const conf = socialConfig[key];

            if(user) {
                let iconHtml = '';
                if(key === 'custom' && customImg) iconHtml = `<div class="icon-box"><img src="${customImg}"></div>`;
                else {
                    let cls = conf.icon;
                    if(cls === 'fab fa-signal-messenger') cls = 'fab fa-signal-messenger';
                    iconHtml = `<div class="icon-box"><i class="${cls}"></i></div>`;
                }

                let displayUrl = user;
                let fullHref = '';
                if (conf.type === 'direct') {
                    if (key === 'email') fullHref = `mailto:${user}`;
                    else if (key === 'phone') fullHref = `tel:${user.replace(/[^0-9+]/g,'')}`;
                    else if (key === 'website') { fullHref = user.startsWith('http') ? user : `https://${user}`; displayUrl = user.replace(/^https?:\/\//, '').replace(/\/$/, ''); }
                    else fullHref = '';
                } else {
                    let prefix = base;
                    if(prefix && !prefix.startsWith('http')) prefix = 'https://' + prefix;
                    fullHref = prefix + user;
                    if(key === 'twitter' || key === 'instagram' || key === 'youtube') displayUrl = user.startsWith('@') ? user : `@${user}`;
                    else displayUrl = user;
                }

                let contentHtml = displayUrl;
                if(fullHref) contentHtml = `<a href="${fullHref}" target="_blank">${displayUrl}</a>`;
                contactContainer.innerHTML += `<div class="contact-item">${iconHtml} ${contentHtml}</div>`;
            }
        });

        renderTags('inp-skills', 'out-skills', 'sec-skills');
        renderTags('inp-langs', 'out-langs', 'sec-langs');

        renderList('list-projects', 'out-projects', 'sec-projects', i => {
            const t = i.querySelector('.i-title').value; if(!t) return '';
            const l = i.querySelector('.i-link').value;
            const s = i.querySelector('.i-stack').value;
            return `<div class="res-item"><div class="res-title">${t}${l?` <a href="${l.startsWith('http')?l:'https://'+l}" target="_blank" class="project-link"><i class="fas fa-external-link-alt"></i> Link</a>`:''}</div>${s?`<div class="tech-stack">${s}</div>`:''}<div class="res-desc">${formatText(i.querySelector('.i-desc').value)}</div></div>`;
        });
        renderList('list-exp', 'out-exp', 'sec-exp', i => {
            const t = i.querySelector('.i-title').value; const c = i.querySelector('.i-company').value; if(!t && !c) return '';
            return `<div class="res-item"><div class="res-header"><div class="res-title">${t}</div><div class="res-date">${i.querySelector('.i-date').value}</div></div><div class="res-subtitle">${c}</div><div class="res-desc">${formatText(i.querySelector('.i-desc').value)}</div></div>`;
        });
        renderList('list-edu', 'out-edu', 'sec-edu', i => {
            const d = i.querySelector('.i-degree').value; if(!d) return '';
            return `<div class="res-item"><div class="res-title" style="font-size:0.95rem">${d}</div><div class="res-subtitle" style="font-size:0.9rem">${i.querySelector('.i-school').value}</div><div class="res-date">${i.querySelector('.i-date').value}</div></div>`;
        });

        const custOut = document.getElementById('out-custom-sections');
        custOut.innerHTML = '';
        document.querySelectorAll('.custom-section-block').forEach(sec => {
            const title = sec.querySelector('.sec-title-inp').value;
            let itemsHtml = '';
            sec.querySelectorAll('.dynamic-item').forEach(itm => {
                const t = itm.querySelector('.i-title').value;
                const d = itm.querySelector('.i-desc').value;
                if(t || d) itemsHtml += `<div class="res-item"><div class="res-title" style="font-size:1rem">${t}</div><div class="res-desc">${formatText(d)}</div></div>`;
            });
            if(title && itemsHtml) custOut.innerHTML += `<div><div class="section-title">${title}</div>${itemsHtml}</div>`;
        });
    }

    /* --- HELPERS --- */
    function toggleSection(id, content, targetId, formattedContent) {
        const el = document.getElementById(id);
        const hasContent = (typeof content === 'string') ? content.trim().length > 0 : content;
        if(hasContent) {
            el.classList.remove('hidden');
            if(targetId) document.getElementById(targetId).innerHTML = formattedContent;
        } else {
            el.classList.add('hidden');
        }
    }

    function formatText(t) {
        if(!t) return '';
        let f = t.replace(/\n/g, '<br>');
        if(t.includes('- ') || t.includes('* ')) {
            const lines = t.split('\n');
            let inL = false, h = '';
            lines.forEach(l => {
                const tr = l.trim();
                if(tr.startsWith('- ') || tr.startsWith('* ')) { if(!inL) { h += '<ul>'; inL = true; } h += `<li>${tr.substring(2)}</li>`; }
                else { if(inL) { h += '</ul>'; inL = false; } h += `${l}<br>`; }
            });
            if(inL) h += '</ul>'; return h;
        }
        return f;
    }

    function renderTags(inp, out, sec) {
        const val = document.getElementById(inp).value;
        const div = document.getElementById(out);
        div.innerHTML = '';
        if(val) { val.split(',').forEach(t => { if(t.trim()) div.innerHTML += `<span class="tag">${t.trim()}</span>`; }); toggleSection(sec, true); }
        else toggleSection(sec, false);
    }

    function renderList(src, tgt, sec, fmt) {
        const t = document.getElementById(tgt); t.innerHTML = ''; let has = false;
        document.querySelectorAll(`#${src} .dynamic-item`).forEach(i => { const html = fmt(i); if(html) { t.innerHTML += html; has = true; } });
        toggleSection(sec, has);
    }

    function downloadPDF() {
        const userName = document.getElementById('inp-name').value || 'Resume';
        const originalTitle = document.title;
        document.title = `${userName} - Resume`;
        window.print();
        setTimeout(() => { document.title = originalTitle; }, 100);
    }

    /* --- STORAGE & JSON EXPORT/IMPORT --- */

    // 1. Helper to gather data from DOM
    function getFormData() {
        const data = {
            inputs: {}, lists: { projects: [], experience: [], education: [], contact: [], customSec: [] },
            color: document.getElementById('color-picker').value,
            lang: document.getElementById('lang-selector').value,
            photo: document.getElementById('out-img-container').style.backgroundImage,
            font: document.getElementById('font-selector').value
        };
        document.querySelectorAll('input:not([type="file"]), textarea').forEach(el => { if(el.id && !el.closest('.dynamic-item')) data.inputs[el.id] = el.value; });
        ['list-projects', 'list-exp', 'list-edu'].forEach(id => { data.lists[id.replace('list-', '')] = getListData(id); });

        const contactItems = [];
        document.querySelectorAll('#list-contact .dynamic-item').forEach(item => {
            contactItems.push({ key: item.querySelector('select').value, base: item.querySelector('.social-base').value, user: item.querySelector('.social-user').value, customImg: item.getAttribute('data-custom-icon') || null });
        });
        data.lists.contact = contactItems;

        const custSecs = [];
        document.querySelectorAll('.custom-section-block').forEach(sec => {
            const items = []; sec.querySelectorAll('.dynamic-item').forEach(itm => { items.push({ title: itm.querySelector('.i-title').value, desc: itm.querySelector('.i-desc').value }); });
            custSecs.push({ id: sec.id, title: sec.querySelector('.sec-title-inp').value, items: items });
        });
        data.lists.customSec = custSecs;
        return data;
    }

    function saveToStorage() {
        const data = getFormData();
        localStorage.setItem('resumeDataUltimate', JSON.stringify(data));
    }

    // 2. Export JSON Function
    function exportJSON() {
        const data = getFormData();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        const name = data.inputs['inp-name'] ? data.inputs['inp-name'].replace(/\s+/g, '_').toLowerCase() : 'resume';
        downloadAnchorNode.setAttribute("download", name + "_data.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // 3. Import JSON Functions
    function triggerImport() {
        document.getElementById('import-json-file').click();
    }

    function loadJSONFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                // Basic validation
                if(!data.inputs || !data.lists) throw new Error("Invalid Resume JSON format");

                // Save to local storage and reload
                localStorage.setItem('resumeDataUltimate', JSON.stringify(data));
                location.reload();
            } catch(err) {
                alert("Error loading JSON: " + err.message);
            }
        };
        reader.readAsText(file);
    }

    function loadFromStorage() {
        const raw = localStorage.getItem('resumeDataUltimate');
        if(!raw) return;
        const data = JSON.parse(raw);
        for (const [id, val] of Object.entries(data.inputs)) { const el = document.getElementById(id); if(el) el.value = val; }
        if(data.photo && data.photo !== 'none') { document.getElementById('out-img-container').style.backgroundImage = data.photo; document.getElementById('out-img-container').style.display = 'block'; }
        if(data.color) { document.getElementById('color-picker').value = data.color; updateColors(); }
        if(data.lang) { document.getElementById('lang-selector').value = data.lang; changeLanguage(); }
        if(data.font) {
            const fs = document.getElementById('font-selector');
            // check if font exists in dropdown, else it might have been a custom Google font
            let exists = false;
            for(let i=0; i<fs.options.length; i++) { if(fs.options[i].value === data.font) exists = true; }
            if(exists) fs.value = data.font;
            // re-trigger font load
            loadGoogleFont(data.font);
        }

        restoreList('list-projects', data.lists.projects, 'projects');
        restoreList('list-exp', data.lists.experience, 'experience');
        restoreList('list-edu', data.lists.education, 'education');

        const contactContainer = document.getElementById('list-contact'); contactContainer.innerHTML = '';
        if(data.lists.contact) { data.lists.contact.forEach(c => addContact(c.key, c.base, c.user, c.customImg)); }
        const custArea = document.getElementById('custom-sections-area'); custArea.innerHTML = '';
        if(data.lists.customSec) { data.lists.customSec.forEach(sec => addCustomSection(sec.id, sec.title, sec.items)); }
    }

    function getListData(id) {
        const items = []; document.getElementById(id).querySelectorAll('.dynamic-item').forEach(item => { const inputs = {}; item.querySelectorAll('input, textarea').forEach(inp => inputs[inp.className] = inp.value); items.push(inputs); }); return items;
    }
    function restoreList(listId, items, type) { document.getElementById(listId).innerHTML = ''; if(items) items.forEach(i => addItem(type, i)); }
    function saveAndRender() { updateResume(); saveToStorage(); }
    function updateColors() { const hex = document.getElementById('color-picker').value; document.documentElement.style.setProperty('--primary-color', hex); document.documentElement.style.setProperty('--accent-color', adjustColor(hex, 40)); saveAndRender(); }
    function adjustColor(c, a) { return '#' + c.replace(/^#/, '').replace(/../g, c => ('0'+Math.min(255, Math.max(0, parseInt(c, 16) + a)).toString(16)).substr(-2)); }
    function loadPhoto(e) { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = function(ev) { document.getElementById('out-img-container').style.backgroundImage = `url(${ev.target.result})`; document.getElementById('out-img-container').style.display = 'block'; saveAndRender(); }; r.readAsDataURL(f); } }
    function changeLanguage() { currentLang = document.getElementById('lang-selector').value; document.querySelectorAll('[data-i18n]').forEach(el => { const k = el.getAttribute('data-i18n'); if(translations[currentLang][k]) el.innerText = translations[currentLang][k]; }); document.getElementById('btn-dl-text').innerText = translations[currentLang].download; saveAndRender(); }
</script>
</body>
</html>